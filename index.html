<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'">
    <title>Postman Helper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="logo">Postman Helper</div>
        <div class="header-actions">
            <button id="newRequestBtn" class="primary" title="New request (&#8984;N)">+ Request</button>
            <button id="newFolderBtn">+ Folder</button>
            <div class="header-divider"></div>
            <button id="importBtn" title="Import collection (&#8984;O)">Import</button>
            <button id="exportBtn" class="primary" title="Export collection (&#8984;&#8679;E)">Export</button>
            <button id="exportDocsBtn" title="Export API Documentation">Docs</button>
            <div class="header-divider"></div>
            <div class="env-selector-group">
                <select id="envSelector">
                    <option value="">No Environment</option>
                </select>
                <button id="manageEnvBtn">Manage</button>
            </div>
            <div class="header-divider"></div>
            <button id="loadSampleBtn" title="Load sample API collection">Sample</button>
            <button id="analyticsBtn" title="Usage analytics dashboard">Analytics</button>
            <button id="settingsBtn" title="Settings (&#8984;,)" aria-label="Settings">&#9881;&#65039;</button>
        </div>
    </header>

    <div class="container">
        <nav class="sidebar" aria-label="Collections">
            <div class="sidebar-header">
                <h3 id="sidebarHeading">Collections</h3>
                <div class="btn-group">
                    <button id="addCollectionBtn" class="secondary">+ Add</button>
                </div>
                <div class="filter-bar" id="filterBar" role="search" aria-label="Filter requests">
                    <input type="text" id="filterText" placeholder="Search requests..." aria-label="Search requests">
                    <button class="filter-clear-btn" id="filterClearBtn" title="Clear search" aria-label="Clear search">&times;</button>
                    <div class="filter-methods" id="filterMethods" role="group" aria-label="Filter by method">
                        <button class="method-chip" data-method="GET" aria-pressed="false">GET</button>
                        <button class="method-chip" data-method="POST" aria-pressed="false">POST</button>
                        <button class="method-chip" data-method="PUT" aria-pressed="false">PUT</button>
                        <button class="method-chip" data-method="DELETE" aria-pressed="false">DEL</button>
                        <button class="method-chip" data-method="PATCH" aria-pressed="false">PATCH</button>
                    </div>
                    <div class="filter-toggles" role="group" aria-label="Filter options">
                        <button class="filter-toggle-btn" id="filterHasTests" aria-pressed="false">Has Tests</button>
                        <button class="filter-toggle-btn" id="filterHasBody" aria-pressed="false">Has Body</button>
                        <button class="filter-toggle-btn" id="filterRegexToggle" title="Enable regex search" aria-pressed="false" aria-label="Enable regex search">.*</button>
                        <button class="filter-clear-btn filter-clear-all-btn" id="filterClearAllBtn" aria-label="Clear all filters">Clear</button>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div id="collectionTree" class="tree-view" role="tree" aria-labelledby="sidebarHeading">
                    <div class="empty-state">No collections yet</div>
                </div>
            </div>
        </nav>

        <div class="resize-handle" id="resizeHandle"></div>

        <div class="main-content" id="mainContent">
            <div class="tabs" role="tablist" aria-label="Request editor tabs">
                <div class="tab active" data-tab="request" role="tab" aria-selected="true" aria-controls="requestTab" tabindex="0" id="tab-request">Request</div>
                <div class="tab" data-tab="inheritance" role="tab" aria-selected="false" aria-controls="inheritanceTab" tabindex="-1" id="tab-inheritance">Inheritance</div>
                <div class="tab" data-tab="tests" role="tab" aria-selected="false" aria-controls="testsTab" tabindex="-1" id="tab-tests">Tests</div>
            </div>

            <div class="tab-content">
                <div id="requestTab" class="tab-pane active" role="tabpanel" aria-labelledby="tab-request">
                    <div class="empty-state">
                        <div style="font-size: 15px; color: var(--text-secondary); font-weight: 500; margin-bottom: 8px;">No request selected</div>
                        <div style="margin-bottom: 16px;">Select a request from the sidebar or create a new one to get started.</div>
                        <div style="display: inline-flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                            <span class="badge" style="font-size: 12px; padding: 4px 10px;">&#8984;N New Request</span>
                            <span class="badge" style="font-size: 12px; padding: 4px 10px;">&#8984;O Open</span>
                            <span class="badge" style="font-size: 12px; padding: 4px 10px;">&#8984;S Save</span>
                        </div>
                    </div>
                </div>

                <div id="inheritanceTab" class="tab-pane" role="tabpanel" aria-labelledby="tab-inheritance" style="display: none;">
                    <div class="inheritance-panel">
                        <h3>&#128279; Inheritance Settings</h3>

                        <div class="inheritance-section">
                            <h4>Global Headers</h4>
                            <div id="globalHeadersContainer" class="headers-container">
                                <div class="empty-state" style="padding: 20px;">No global headers defined</div>
                            </div>
                            <button id="addGlobalHeaderBtn" class="add-header-btn">+ Add Header</button>
                            <button id="copyHeadersFromRequestBtn" class="add-header-btn secondary" style="margin-left: 6px;">Copy from Request</button>
                        </div>

                        <div class="inheritance-section">
                            <h4>Base Endpoints</h4>
                            <div id="baseEndpointsContainer">
                                <div class="empty-state" style="padding: 20px;">No base endpoints defined</div>
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="text" id="newBaseEndpoint" placeholder="https://api.example.com/v1" class="form-control" style="display: inline-block; width: 70%;">
                                <button id="addBaseEndpointBtn" style="display: inline-block; width: 28%; margin-left: 2%;">Add Endpoint</button>
                            </div>
                        </div>

                        <div class="inheritance-section">
                            <h4>Body Templates</h4>
                            <div id="bodyTemplatesContainer">
                                <div class="empty-state" style="padding: 20px;">No body templates defined</div>
                            </div>
                            <button id="addBodyTemplateBtn" class="add-header-btn">+ Add Template</button>
                            <button id="copyBodyFromRequestBtn" class="add-header-btn secondary" style="margin-left: 6px;">Copy from Request</button>
                        </div>

                        <div class="inheritance-section">
                            <h4>Test Templates</h4>
                            <div id="testTemplatesContainer">
                                <div class="empty-state" style="padding: 20px;">No test templates defined</div>
                            </div>
                            <button id="addTestTemplateBtn" class="add-header-btn">+ Add Template</button>
                            <button id="copyTestsFromRequestBtn" class="add-header-btn secondary" style="margin-left: 6px;">Copy from Request</button>
                        </div>

                        <div class="inheritance-section">
                            <h4>Auth Presets</h4>
                            <div class="btn-group" style="flex-wrap: wrap;">
                                <button id="addBearerTokenBtn" class="secondary">Bearer Token</button>
                                <button id="addApiKeyBtn" class="secondary">API Key</button>
                                <button id="addBasicAuthBtn" class="secondary">Basic Auth</button>
                            </div>
                        </div>

                        <div class="inheritance-section">
                            <h4>Reset</h4>
                            <button id="resetAllInheritanceBtn" class="secondary" style="background: #dc3545; color: white;">Reset All Inheritance</button>
                        </div>
                    </div>
                </div>

                <div id="testsTab" class="tab-pane" role="tabpanel" aria-labelledby="tab-tests" style="display: none;">
                    <div class="empty-state">
                        Select a request to view and edit tests
                    </div>
                </div>
            </div>

            <!-- Version History Panel (slide-in from right) -->
            <div id="historyPanel" class="history-panel" style="display: none;">
                <div class="history-header">
                    <h3>Version History</h3>
                    <button id="closeHistoryBtn" class="btn-sm" title="Close history panel">Close</button>
                </div>
                <div id="historyList" class="history-list">
                    <div class="empty-state" style="padding: 16px;">No versions saved yet. Save a request to start tracking history.</div>
                </div>
                <div id="historyDiff" class="history-diff"></div>
            </div>
        </div>
    </div>

    <!-- Analytics Dashboard Panel -->
    <div id="analyticsPanel" class="analytics-panel" style="display: none;">
        <div class="analytics-header">
            <h2>Usage Analytics</h2>
            <div class="analytics-actions">
                <button id="exportAnalyticsBtn" class="btn-sm secondary">Export</button>
                <button id="clearAnalyticsBtn" class="btn-sm secondary" style="color: #f93e3e;">Clear Data</button>
                <button id="closeAnalyticsBtn" class="btn-sm">Close</button>
            </div>
        </div>
        <div class="analytics-grid">
            <div class="stat-card">
                <div class="stat-value" id="statRequestsSent">0</div>
                <div class="stat-label">Requests Sent</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAvgResponse">0ms</div>
                <div class="stat-label">Avg Response Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statSuccessRate">0%</div>
                <div class="stat-label">Success Rate (2xx)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCollections">0</div>
                <div class="stat-label">Collections Created</div>
            </div>
        </div>
        <div class="analytics-charts">
            <div class="chart-container" id="methodChart">
                <h3>HTTP Methods</h3>
            </div>
            <div class="chart-container" id="statusChart">
                <h3>Status Codes</h3>
            </div>
            <div class="chart-container" id="endpointsChart">
                <h3>Top Endpoints</h3>
            </div>
            <div class="chart-container" id="activityChart">
                <h3>Daily Activity (Last 30 Days)</h3>
            </div>
        </div>
    </div>

    <!-- Plugin Manager Panel -->
    <div id="pluginPanel" class="plugin-panel" style="display: none;">
        <div class="plugin-header">
            <h2>Plugins</h2>
            <div class="plugin-actions">
                <button id="refreshPluginsBtn" class="btn-sm secondary">Refresh</button>
                <button id="closePluginsBtn" class="btn-sm">Close</button>
            </div>
        </div>
        <div id="pluginList" class="plugin-list">
            <div class="plugin-empty">No plugins installed. Place plugin folders in ~/.postman-helper/plugins/</div>
        </div>
    </div>

    <!-- AI Assistant FAB + Panel -->
    <button id="aiAssistantFab" class="ai-fab" title="AI Assistant" aria-label="Open AI Assistant">
        <svg class="ai-fab-icon" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z"/>
        </svg>
        <span class="ai-fab-label">AI</span>
    </button>

    <div id="aiPanel" class="ai-panel" style="display:none;">
        <div class="ai-panel-header">
            <div class="ai-panel-title">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z"/></svg>
                AI Assistant
            </div>
            <div class="ai-panel-actions">
                <button id="aiPanelClearBtn" class="ai-panel-btn" title="Clear chat">Clear</button>
                <button id="aiPanelCloseBtn" class="ai-panel-btn" title="Close" aria-label="Close AI panel">&times;</button>
            </div>
        </div>
        <div id="aiQuickActions" class="ai-quick-actions">
            <button class="ai-action-btn" data-action="headers" title="Suggest headers for current request">
                <span class="ai-action-icon">H</span> Suggest Headers
            </button>
            <button class="ai-action-btn" data-action="body" title="Generate sample request body">
                <span class="ai-action-icon">{}</span> Generate Body
            </button>
            <button class="ai-action-btn" data-action="tests" title="Generate test scripts">
                <span class="ai-action-icon">T</span> Generate Tests
            </button>
            <button class="ai-action-btn" data-action="url" title="Suggest URL completions">
                <span class="ai-action-icon">/</span> Complete URL
            </button>
            <button class="ai-action-btn ai-action-error" data-action="error" title="Analyze last response error" style="display:none;">
                <span class="ai-action-icon">!</span> Analyze Response
            </button>
        </div>
        <div id="aiMessages" class="ai-messages">
            <div class="ai-welcome-msg">
                <p>Ask me anything about your API requests, or use the quick actions above.</p>
            </div>
        </div>
        <div class="ai-input-area">
            <textarea id="aiChatInput" class="ai-chat-input" placeholder="Ask about your API request..." rows="1"></textarea>
            <button id="aiSendBtn" class="ai-send-btn" title="Send message" aria-label="Send">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
        <div id="aiNotConfigured" class="ai-not-configured" style="display:none;">
            <p>AI is not configured. Open <strong>Settings</strong> to add your API key.</p>
            <button id="aiOpenSettingsBtn" class="secondary" style="font-size:12px;padding:4px 12px;">Open Settings</button>
        </div>
    </div>

    <div class="status-bar" role="status" aria-live="polite" aria-label="Application status">
        <div>Postman Helper v1.98 | Ready</div>
        <div id="statusInfo" aria-live="polite">No collection loaded</div>
    </div>

    <script src="app.js"></script>
</body>
</html>
